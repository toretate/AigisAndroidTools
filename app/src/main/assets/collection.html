<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="Content-Script-Type" content="text/javascript">
    	<meta name="viewport" content="width=device-width, initial-scale=1">
    	<title>収集管理</title>

    	<!-- BootstrapのCSS読み込み -->
    	<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">

    	<style>
    		.progress {
    			box-shadow: none;
    			-webkit-box-shadow: none;
    		}
			table .progress {
				margin-bottom: 0;
			}
			.padding-zero {
				padding: 0px;
				height: auto;
			}
			.img16 {
			}
			.c1 {
				width: 16px; height: 16px;
				background-image: url("./ic_collect_1.png");
				display: inline-block;
				position: relative;
				background-size: contain;
			}
			.c3 {
				width: 16px; height: 16px;
				background-image: url("./ic_collect_3.png");
				display: inline-block;
				position: relative;
				background-size: contain;
			}
			.c5 {
				width: 16px; height: 16px;
				background-image: url("./ic_collect_5.png");
				display: inline-block;
				position: relative;
				background-size: contain;
			}
    	</style>
	</head>
<body>

<!-- 収集イベントの管理用 -->

<div class="panel-group">
	<div class="panel panel-default">
		<span id="remainTime">あとα日β時間</span> <span id="remainParts">目標までy個</span>
	</div>
	<div class="panel panel-default">
		<table class="table table-condensed table-striped">
			<tbody>
			<tr class="progress">
				<td class="col-xs-2">目標</td>
				<td><div class="progress-bar progress-bar-info" id="collection_bar_target" style="width:80%;" /></td>
				<td class="col-xs-1"><a id="collection_edit_target"><span class="glyphicon glyphicon-pencil" /></a></td>
			</tr>
			<tr class="progress">
				<td class="col-xs-2">ﾍﾟｰｽ</td>
				<td><div class="progress-bar progress-bar-warning progress-bar-striped" id="collection_bar_pase" style="width:50%;" /></td>
				<td class="col-xs-1" />
			</tr>
			<tr class="progress">
				<td class="col-xs-2">現在</td>
				<td><div class="progress-bar progress-bar-success progress-bar-striped" id="collection_bar_current" style="width:50%;" /></td>
				<td class="col-xs-1"><a id="collection_edit_current"><span class="glyphicon glyphicon-pencil" /></a></td>
			</tr>
			</tbody>
		</table>
		現在のペースだと<span id="collection_current_pase_max">n</span>個の予定です
	</div>
</div>

<div class="panel-group">
	<div class="panel panel-header">
		<a data-toggle="collapse" href="#collapseDrop"><span class="glyphicon glyphicon-triangle-bottom" />古代龍の目覚め ドロップ表</a>
	</div>
	<div id="collapseDrop" class="panel panel-default panel-collapse collapse">
		<table class="table table-condensed table-striped">
			<colgroup><col/><col class="col-xs-1"/><col class="col-xs-1"/><col/></colgroup>
			<tbody>
			<tr><th>名前</th>			<th> ｶﾘ</th><th>ｽﾀ</th><th>ドロップ表</th></tr>
			<tr><td>悠久を生きし龍</td>		<td> 20</td><td> 1</td><td><span class="c1"></span>x2, 花束</td></tr>
			<tr><td>古代龍の眠る島</td>	<td> 30</td><td> 2</td><td><span class="c1"></span>x3, ｳﾞｪﾛｯﾃ, 魔2</td></tr>
			<tr><td>封印のほこら</td>		<td> 40</td><td> 4</td><td><span class="c3"></span>x1, <span class="c1"></span>x3, ﾆｴﾙ, ﾏｰﾔ</td></tr>
			<tr><td>雨下の激戦</td>		<td> 50</td><td> 7</td><td><span class="c5"></span>x2, <span class="c3"></span>x2, ﾈｰﾆｬ, 白聖</td></tr>
			<tr><td>樹霊の暴走</td>		<td> 80</td><td> 9</td><td><span class="c5"></span>x3, ﾛｻﾞﾘｰ, ﾛｰﾚﾝ, 魔2</td></tr>
			<tr><td>河童の雨乞い</td>		<td> 40</td><td> 5</td><td><span class="c3"></span>x3, ｲﾛﾊ, 女王, 白鎧</td></tr>
			<tr><td>大海原を泳ぐ巨龍</td>	<td> 70</td><td> 8</td><td><span class="c5"></span>x2, <span class="c3"></span>x1, ﾊﾘｯｻ, ﾙﾋﾞｰ</td></tr>
			<tr><td>古代龍の目覚め</td>	<td> 90</td><td>12</td><td><span class="c5"></span>x4, <span class="c3"></span>x2, 技聖</td></tr>
			<tr><td>新たなるｷｮﾝｼｰ</td>		<td>100</td><td> 2</td><td>金聖, 白聖, 黒聖, 技聖</td></tr>
			</tbody>
		</table>
	</div>
</div>

<div class="panel-group">
	<div class="panel panel-header">
		<a data-toggle="collapse" href="#collapseReward"><span class="glyphicon glyphicon-triangle-bottom" />古代龍の目覚め 報酬表</a>
	</div>
	<div id="collapseReward" class="panel panel-default panel-collapse collapse">
		<table class="table table-condensed table-striped">
			<colgroup><col class="col-xs-2"/><col class="col-xs-4"/></colgroup>
			<colgroup><col class="col-xs-2"/><col class="col-xs-4"/></colgroup>
			<tbody>
			<tr><th>個数</th><th>報酬</th>		<th>個数</th><th>報酬</th></tr>
			<tr><td> 10</td><td>仲間加入</td>		<td> 600</td><td>コスト -3</td></tr>
			<tr><td> 30</td><td>スキル 2</td>		<td> 700</td><td>スキル 7</td></tr>
			<tr><td> 50</td><td>初期Lv. 10</td>	<td> 800</td><td>初期Lv. 30</td></tr>
			<tr><td>100</td><td>スキル 3</td>		<td> 900</td><td>スキル 8</td></tr>
			<tr><td>150</td><td>コスト -1</td>		<td>1000</td><td>コスト -4</td></tr>
			<tr><td>200</td><td>スキル 4</td>		<td>1100</td><td>初期Lv. 40</td></tr>
			<tr><td>250</td><td>コスト -2</td>		<td>1200</td><td>スキル 9</td></tr>
			<tr><td>300</td><td>スキル 5</td>		<td>1300</td><td>コスト -5</td></tr>
			<tr><td>400</td><td>初期Lv. 20</td>	<td>1400</td><td>スキル 10</td></tr>
			<tr><td>500</td><td>スキル 6</td>		<td>1500</td><td>初期Lv. 50</td></tr>
			</tbody>
		</table>
	</div>
</div>

<div class="panel-group">
	<div class="panel panel-header">
		<a data-toggle="collapse" href="#collapseAppendReward"><span class="glyphicon glyphicon-triangle-bottom" />古代龍の目覚め 追加報酬表</a>
	</div>
	<div id="collapseAppendReward" class="panel panel-default panel-collapse collapse">
		<table class="table table-condensed table-striped">
			<colgroup><col class="col-xs-1"/><col class="col-xs-2"/></colgroup>
			<colgroup><col class="col-xs-1"/><col class="col-xs-2"/></colgroup>
			<colgroup><col class="col-xs-1"/><col class="col-xs-2"/></colgroup>
			<colgroup><col class="col-xs-1"/><col class="col-xs-2"/></colgroup>
			<tbody>
			<tr><th>個数</th><th>報酬</th>	<th>個数</th><th>報酬</th>	<th>個数</th><th>報酬</th>	<th>個数</th><th>報酬</th></tr>
			<tr><td> 45</td><td>金ア</td>	<td>495</td><td>結欠</td>	<td> 945</td><td>白ア</td>	<td>1395</td><td>黒聖</td></tr>
			<tr><td> 90</td><td>金聖</td>	<td>540</td><td>黒聖</td>	<td> 990</td><td>白聖</td>	<td>1440</td><td>白聖</td></tr>
			<tr><td>135</td><td>白ア</td>	<td>585</td><td>金ア</td>	<td>1035</td><td>絆聖</td>	<td>1485</td><td>白ア</td></tr>
			<tr><td>180</td><td>金聖</td>	<td>630</td><td>技聖</td>	<td>1080</td><td>白聖</td>	<td>1530</td><td>白聖</td></tr>
			<tr><td>225</td><td>結欠</td>	<td>675</td><td>白ア</td>	<td>1125</td><td>結欠</td>	<td>1575</td><td>結欠</td></tr>
			<tr><td>270</td><td>白聖</td>	<td>720</td><td>白聖</td>	<td>1170</td><td>黒聖</td>	<td>1620</td><td>黒聖</td></tr>
			<tr><td>315</td><td>金ア</td>	<td>765</td><td>絆金</td>	<td>1215</td><td>白ア</td>	<td>1665</td><td>金ア</td></tr>
			<tr><td>360</td><td>白聖</td>	<td>810</td><td>白聖</td>	<td>1260</td><td>黒聖</td>	<td>1710</td><td>黒聖</td></tr>
			<tr><td>405</td><td>白ア</td>	<td>855</td><td>結欠</td>	<td>1305</td><td>絆黒</td>	<td>1755</td><td>白ア</td></tr>
			<tr><td>450</td><td>黒聖</td>	<td>900</td><td>黒聖</td>	<td>1350</td><td>技聖</td>	<td>1800</td><td>技聖</td></tr>
			</tbody>
		</table>
	</div>
</div>

<!-- 数値入力ダイアログ -->
<div class="modal fade" id="number-modal-dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
      	<input id="number-dialog-input" type="number" class="form-control" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default btn-primary">保存</button>
      </div>
    </div>
  </div>
</div>

<!-- jQuery読み込み -->
<script src="./jquery-1.12.4.min.js"></script>
<!-- BootstrapのJS読み込み -->
<script src="bootstrap/js/bootstrap.js"></script>

<script>
$(function(){

	var collection_current;	// 収集個数
	var collection_target;	// 収集目標
	var collection_max;		// 今回の収集MAX(もらえる最大個数)

	// 固定時間
	var start = new Date( 2017, 2, 9, 15, 0, 0, 0, 0 );	// 15時開始とする
	var last = new Date( 2017, 2, 23, 10, 0, 0, 0, 0 );	// 10時終了

	// Modalの状態保持
	var $modal_open_from;

	function isAndroid() {
		var agent = navigator.userAgent;
		if( agent.search(/Android/) != -1 ) {
			return true;
		} else {
			return false;
		}
	}

	/**
	 * パラメータの初期化を行う。必要があればシステムからデータを取ってくる
	 */
	function loadParameters() {
		if( isAndroid() ) {
			collection_current = wbAPI.loadCurrent();
			collection_target = wbAPI.loadTarget();
			collection_max = wbAPI.loadMax();
		} else {
			collection_current = window.localStorage["CollectionCurrent"];
			collection_target = window.localStorage["CollectionTarget"];
			collection_max = window.localStorage["CollectionMax"];
			if( collection_current == null )collection_current = 200;
			if( collection_target == null )	collection_target = 1300;
			if( collection_max == null )	collection_max = 1500;
		}

		// ゲージの初期化
		showRemainTimeAndParts();
	}

	function saveParameters() {
		if( isAndroid() ) {
			wbAPI.save(
					collection_current
					, collection_target
					, collection_max
				);
		} else {
			window.localStorage["CollectionCurrent"] = collection_current;
			window.localStorage["CollectionTarget"] = collection_target;
			window.localStorage["CollectionMax"] = collection_max;
		}
	}

	function showRemainTimeAndParts() {
		// 時間
		var current = new Date();

		showRemainTime( current );
		showParts( current );
	}

	function showRemainTime( current ) {
		if( last < current ) {
			$("#remainTime").text( "終了しました" );
		} else {
			var dDay = last.getDate() - current.getDate();

			var cHour = current.getHours();
			var dHour = cHour < 10 ? last.getHours() - cHour : last.getHours() + 24 - cHour;
			dHour -= 1; // 現時刻が 0M 0s 0ms なわけないので -1 しておく

			$("#remainTime").text( "あと" +dDay +"日" +dHour +"時間" );
		}
	}

	function showParts( current ) {
		// 収集個数
		var collection_remain = collection_target - collection_current;
		$("#remainParts").text( "あと" +collection_remain +"個" );

		var percent;
		// 目標のゲージ位置
		percent = Math.round( collection_target / collection_target * 100 );
		$("#collection_bar_target").css( {'width': percent + '%'} );
		$("#collection_bar_target").text( collection_target );

		// 目標までのペース位置
		{
			var target_par_hour = collection_target / ( 14 * 24 ); // targetを14日間の時間数で割った個数
			var dHourTime = Math.round( ( current.getTime() - start.getTime() ) / 3600000 );	// 経過時間(H)

			var target_pase_current = Math.round( target_par_hour * dHourTime );	// target/h のとき、現時刻の個数

			percent = Math.round( target_pase_current / collection_target * 100 );
			$("#collection_bar_pase").css( {'width': percent +'%'} );
			$("#collection_bar_pase").text( target_pase_current + " (" +target_par_hour.toFixed(1) +" / 時)" );
		}

		// 現在のゲージ位置
		{
			percent = Math.round( collection_current / collection_target * 100 );
			$("#collection_bar_current").css( {'width': percent +'%'} );
			$("#collection_bar_current").text( collection_current + " (" + percent + "%)" );
		}

		// 現在のペースで何個になるか
		{
			var dHourTime = Math.round( ( current.getTime() - start.getTime() ) / 3600000 );	// 経過時間(H)
			var current_par_hour = collection_current / ( dHourTime ); // currentを現在までの経過時間数で割った個数

			var current_pase_max = Math.floor( current_par_hour * 14 * 24 );	// 14日 x 24時間
			$("#collection_current_pase_max").text( current_pase_max );
		}
	}

	$(window).load( loadParameters() );

	// イベント処理
	$( "#collection_edit_target" ).on( 'click', function() {
		$modal_open_from = $( "#collection_edit_target" ).get(0);
		$( '#number-dialog-input' ).val( collection_target );
		$( '#number-modal-dialog' ).modal('show');
	});
	$( "#collection_edit_current" ).on( 'click', function() {
		$modal_open_from = $( "#collection_edit_current" ).get(0);
		$( '#number-dialog-input' ).val( collection_current );
		$( '#number-modal-dialog' ).modal('show');
	});
	$( '#number-modal-dialog' ).on( 'shown.bs.modal', function() { $( '#number-dialog-input').focus(); } );
	$( '#number-modal-dialog' ).on( 'click', '.modal-footer .btn-primary', function() {
		$( '#number-modal-dialog' ).modal( 'hide' );
		var value = $( '#number-dialog-input' ).val();
		if( $modal_open_from == $('#collection_edit_target').get(0) ) {
			collection_target = value;
		} else {
			collection_current = value;
		}
		saveParameters();
		showRemainTimeAndParts();
	});

	// Collapseの開閉による変更
	$('.collapse').on('show.bs.collapse', function() {
		var v1 = $(this).parent().find("span:first");
		v1.attr('class', 'glyphicon glyphicon-triangle-bottom');
	});
	$('.collapse').on('hide.bs.collapse', function() {
		var v1 = $(this).parent().find("span:first");
		v1.attr('class', 'glyphicon glyphicon-triangle-right');
	});

});

</script>


</body>
</html>